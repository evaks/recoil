<html>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<title>recoil.ui.widgets.TableWidget</title>
<script src="../../../../../closure-library/closure/goog/base.js"></script>
<script src="../../../../../my-deps.js"></script>

<script>
  goog.require('recoil.frp.Frp');
  goog.require('recoil.ui.widgets.table.TableWidget');
  goog.require('recoil.ui.widgets.TableMetaData');
  goog.require('recoil.ui.widgets.ButtonWidget');
  goog.require('recoil.ui.BoolWithExplaination');
  goog.require('recoil.ui.WidgetScope');
  goog.require('recoil.ui.widgets.table.StringColumn');
  goog.require('recoil.ui.widgets.table.NumberColumn');
  goog.require('recoil.ui.widgets.table.BooleanColumn');
</script>
<style>
  .recoil_table_selected {background-color:green;}
</style>

<body>
  <div id='tablediv'/>
  <div id='addB'/>
  <div id='hideB'/>
  <div id='hideHeadersB'/>
  <div id='showB'/>
  <div id='deleteB'/>
  <div class="selected" id='clickTest'>Click Test
    </div>
  TODO <br/>all decorators<br/>
  hide/show headers <br/>
  cell renderers<br/>
  
  <script>
    var scope = new recoil.ui.WidgetScope();
    var frp = scope.getFrp();
    var $ = goog.dom.getElement;
    var toSet = frp.createCallback(
    function(e) {console.log("event",e);});
    
    
    recoil.ui.events.listen($('clickTest'), goog.events.EventType.CLICK,
    toSet);

    frp.tm().attach(toSet);
    var rawTable = [
    {id: 1, name: "row 1", count:2, check: true},
    {id: 2, name: "row 2", count:4, check: true},
    {id: 3, name: "row 3", count:6, check: true}];

    var tblKeys = {
    id : new recoil.structs.table.ColumnKey("id_"),
    name : new recoil.structs.table.ColumnKey("name_"),
    count: new recoil.structs.table.ColumnKey("count_"),
    check :  new recoil.structs.table.ColumnKey("check_")
    };

    var rawTableMeta = {
    name : { type : "string", length : 20, key : tblKeys.name},
    id : { type : "int", primary : 0, key : tblKeys.id},
    count : { type: "int", min : 1, max:100, key: tblKeys.count},
    check : { type: "bool", key: tblKeys.check}
    };

    var columns = new recoil.ui.widgets.TableMetaData();
    columns.add(tblKeys.name, "Name");
    columns.add(tblKeys.count, "Count");
    columns.add(tblKeys.check, "Check");

    //this is wrong we can't simply go create b because tableMetaData contain
    //behaviours

    //var columnsB = columns.createB(frp);

    var  columnsB = frp.createB(columns);
    


    var typeFactories = {"int": function(meta) {
        return new recoil.ui.widgets.table.NumberColumn(meta);
    }, "string": function (meta) {
        return new recoil.ui.widgets.table.StringColumn(meta);
    }, "boolean": function (meta) {
        return new recoil.ui.widgets.table.BooleanColumn(meta);
    }};

    var table = recoil.frp.debug.debug("TABLE",frp.createB(recoil.structs.table.Table.create(typeFactories, rawTableMeta, rawTable)));
    frp.tm().attach(table);
    var tableWidget = new recoil.ui.widgets.table.TableWidget(scope);

    console.log('table', $('tablediv'), tableWidget.getComponent().getElement());


    var buttonWidget = new recoil.ui.widgets.ButtonWidget(scope);
    var deleteButton = new recoil.ui.widgets.ButtonWidget(scope);

    buttonWidget.attach("", "Add Row", frp.createCallback(function () {
    var ids = [];
    var max = 0;
    table.get().forEach( function(row) {
    ids.push(row.get(tblKeys.id));
    });
    ids.sort();
    for (var i = 0; i < ids.length; i++) {
			if (max !== ids[i]) {
			break;
			}
			max++;
    }

    var mtable = table.get().unfreeze();
    var row = new recoil.structs.table.MutableTableRow();
    row.set(tblKeys.id, max);
    row.set(tblKeys.name, "row "+ max);
    row.set(tblKeys.count, max);
    row.set(tblKeys.check, false);
    
    mtable.addRow(row);
    table.set(mtable.freeze());
    }, table));
			tableWidget.attach(table,recoil.frp.debug.debug("COLUMS", columnsB));
			
    var hideWidget = new recoil.ui.widgets.ButtonWidget(scope);
    var hideHeadersWidget = new recoil.ui.widgets.ButtonWidget(scope);
    var showWidget = new recoil.ui.widgets.ButtonWidget(scope);

			hideHeadersWidget.attach("", "Hide/Show Headers", frp.createCallback(
			function() {
			var mtable =table.get().unfreeze();
			var tmeta = mtable.getMeta();
			if (tmeta.headerRowDecorator) {
			delete tmeta['headerRowDecorator'];
			}
			else {
			tmeta.headerRowDecorator = function () {
			return null;
			};
			}
			table.set(mtable.freeze());
			console.log("table meta", tmeta);
			},table));
			
    hideWidget.attach("", "Hide", frp.createCallback(function () {
    var columns = new recoil.ui.widgets.TableMetaData();
    columns.add(tblKeys.name, "Name");
    //columns.add(tblKeys.count, "Count");
    columns.add(tblKeys.check, "Check");
    columnsB.set(columns);
    },columnsB));

    var selectedB = tableWidget.createSelected();
    
    deleteButton.attach("", "Delete", frp.createCallback(function() {
    console.log(selectedB.get());
    var selected = selectedB.get();
    var mtable = table.get().unfreeze();
    
    for (var i = 0; i < selected.length; i++) {
	mtable.removeRow(selected[i]);
    }
	table.set(mtable.freeze());
    }, selectedB, table));


    showWidget.attach("", "Show", frp.createCallback(function () {
    var columns = new recoil.ui.widgets.TableMetaData();
    columns.add(tblKeys.name, "Name");
    columns.add(tblKeys.count, "Count");
    columns.add(tblKeys.check, "Check");
    columnsB.set(columns);
    },columnsB));

    tableWidget.getComponent().render($('tablediv'));
    buttonWidget.getComponent().render($('addB'));
    hideWidget.getComponent().render($('hideB'));
    hideHeadersWidget.getComponent().render($('hideHeadersB'));
    showWidget.getComponent().render($('showB'));
    deleteButton.getComponent().render($('deleteB'));

    
  </script>

</body>

</html>


